---
title: "Journal (reproducible report)"
author: "Mimololorun Aiyelari"
date: "2020-11-05"
output:
  html_document: 
    toc: true
    toc_float: true
    collapsed: false
    number_sections: true
    toc_depth: 3
    #code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE,warning=FALSE, cache=TRUE)
```



# Challenge 1
## Introduction to the Tidyverse
```{r}
#Challenge 1 -Introduction to the Tidyverse ----

#1.0 Load packages ----
library(tidyverse)
library(readxl)

#2.0 Import Files ----
# A good convention is to use the file name and suffix it with tbl for the data structure tibble
bikes_tbl      <- read_excel(path = "~/Documents/Github/Business Data Basics/DS_101/00_data/01_bike_sales/01_raw_data/bikes.xlsx")
orderlines_tbl <- read_excel("~/Documents/Github/Business Data Basics/DS_101/00_data/01_bike_sales/01_raw_data/orderlines.xlsx")

# Not necessary for this analysis, but for the sake of completeness
bikeshops_tbl  <- read_excel("~/Documents/Github/Business Data Basics/DS_101/00_data/01_bike_sales/01_raw_data/bikeshops.xlsx")

#3.0 Joining Data ----

left_join(orderlines_tbl, bikes_tbl, by = c("product.id" = "bike.id"))

# Chaining commands with the pipe and assigning it to order_items_joined_tbl
bike_orderlines_joined_tbl <- orderlines_tbl %>%
  left_join(bikes_tbl, by = c("product.id" = "bike.id")) %>%
  left_join(bikeshops_tbl, by = c("customer.id" = "bikeshop.id"))

#4.0 Data Wrangling ----
bike_orderlines_wrangled_tbl <- bike_orderlines_joined_tbl %>%
  # 4.1 Separate category name
  separate(col    = category,
           into   = c("category.1", "category.2", "category.3"),
           sep    = " - ") %>%
  
  # 4.2 Add the total price (price * quantity) 
  # Add a column to a tibble that uses a formula-style calculation of other columns
  mutate(total.price = price * quantity) %>%
  
  # 4.3 Optional: Reorganize. Using select to grab or remove unnecessary columns
  # 4.3.1 by exact column name
  select(-...1, -gender) %>%
  
  # 4.3.2 by a pattern
  # You can use the select_helpers to define patterns. 
  # Type ?ends_with and click on Select helpers in the documentation
  select(-ends_with(".id")) %>%
  
  # 4.3.3 Actually we need the column "order.id". Let's bind it back to the data
  bind_cols(bike_orderlines_joined_tbl %>% select(order.id)) %>% 
  
  # 4.3.4 You can reorder the data by selecting the columns in your desired order.
  # You can use select_helpers like contains() or everything()
  select(order.id, contains("order"), contains("model"), contains("category"),
         price, quantity, total.price,
         everything()) %>%
  
  # 4.4 Rename columns because we actually wanted underscores instead of the dots
  # (one at the time vs. multiple at once)
  rename(bikeshop = name) %>%
  set_names(names(.) %>% str_replace_all("\\.", "_"))

#Check location multiple features (State and city)
#bike_orderlines_wrangled_tbl$location

#Probably unecessary code but also helps to see just the location column
bike_orderlines_wrangled_tbl %>% 
  select(location) %>%
  filter(str_detect(location, "^Hamburg")) 

#data wrangling for challenge starts here 
#4.5 Separate location into state and city
 bike_orderlines_wrangled2_tbl <- bike_orderlines_wrangled_tbl %>%
  separate(col    = location,
           into   = c("city", "state"),
           sep    = (",")) 
 
#5.0 Business Insights ----
#5.1 Sales by location (state) ----

 #step 1: Manipulate

 sales_by_state_tbl <- bike_orderlines_wrangled2_tbl %>%
   # Select columns
   select(state, total_price) %>%
   
   # Grouping by state and summarizing sales
   group_by(state) %>% 
   summarize(sales = sum(total_price)) %>%
   
   # Add a column that turns the numbers into a currency format 
   # mutate(sales_text = scales::dollar(sales)) <- Works for dollar values
   mutate(sales_text = scales::dollar(sales, big.mark = ".", 
                                      decimal.mark = ",", 
                                      prefix = "", 
                                      suffix = " €"))
 
 sales_by_state_tbl
 
 #Plot bar chart(This is for Rmarkdown. Not sure how to use that just about yet)
 #```{r plot, fig.width=10, fig.height=7}
 
 #step 2: Visualize
 #plot a bar chart
 sales_by_state_tbl %>%
   
   # Setup canvas with the columns year (x-axis) and sales (y-axis)
   ggplot(aes(x = state, y = sales)) +
   
   # Geometries
   geom_col(fill = "#2DC6D6") + # Use geom_col for a bar plot
   #geom_label(aes(label = sales_text)) + # Adding labels to the bars
   #geom_smooth(method = "lm", se = FALSE) + # Adding a trendline
   
   # Formatting
   # scale_y_continuous(labels = scales::dollar) + # Change the y-axis. 
   # Again, we have to adjust it for euro values
   scale_y_continuous(labels = scales::dollar_format(big.mark = ".", 
                                                     decimal.mark = ",", 
                                                     prefix = "", 
                                                     suffix = " €")) +
   labs(
     title    = "Revenue by state",
     #subtitle = "Upward Trend",
     x = "state", # Override defaults for x and y
     y = "Revenue")+
   theme(axis.text.x = element_text(angle = 45, hjust = 1))#rotate x-axis 
   
#5.2 Sales by location(State) and year ----
 library(lubridate)
 #step 1: Manipulate
 
 sales_by_year_by_state_tbl <- bike_orderlines_wrangled2_tbl %>%
   
   # Select columns and add a year
   select(order_date, total_price, state) %>%
   mutate(year = year(order_date)) %>%
   
   # Group by and summarize year and state
   group_by(year, state) %>%
   summarise(sales = sum(total_price)) %>%
   ungroup() %>%
   
   # Format $ Text
   mutate(sales_text = scales::dollar(sales, big.mark = ".", 
                                      decimal.mark = ",", 
                                      prefix = "", 
                                      suffix = " €")) %>%
 arrange(desc(sales))
 
 sales_by_year_by_state_tbl
 
 #step 2: visualize
 
 #Plot bar chart(facet_wrap)
 sales_by_year_by_state_tbl %>%
   
   # Set up x, y, fill
   ggplot(aes(x = year, y = sales, fill = state)) +
   
   # Geometries
   geom_col() + # Run up to here to get a stacked bar plot
   
   # Facet
   facet_wrap(~ state) +
   
   # Formatting
   scale_y_continuous(labels = scales::dollar_format(big.mark = ".", 
                                                     decimal.mark = ",", 
                                                     prefix = "", 
                                                     suffix = " €")) +
   labs(
     title = "Revenue by year and state",
     fill = "State" # Changes the legend name
   )+ 
   theme(axis.text.x = element_text(angle = 90, hjust = 1))

 #6.0 Write files into excel ----
 #6.1 Excel ----
 library("writexl")
 bike_orderlines_wrangled2_tbl %>%
   write_xlsx("~/Documents/GitHub/Business Data Basics/DS_101/00_data/01_bike_sales/02_wrangled_data/bike_orderlines2.xlsx")
 
 # 6.2 CSV ----
 bike_orderlines_wrangled2_tbl %>% 
   write_csv("~/Documents/GitHub/Business Data Basics/DS_101/00_data/01_bike_sales/02_wrangled_data/bike_orderlines2.csv")
 
 # 6.3 RDS ----
 bike_orderlines_wrangled2_tbl %>% 
   write_rds("~/Documents/GitHub/Business Data Basics/DS_101/00_data/01_bike_sales/02_wrangled_data/bike_orderlines2.rds")
 

```

Last compiled: `r Sys.Date()`


# Challenge 2
## Data Acquisition
```{r}
#Challenge 2.0 : Data Acquisition ----

#2.1: Data from an API ----

#first ensure required package is installed
#install.packages("httr")
library(glue)
library(httr)

#Trying this API thing using a food website API I found. Hopefully, it works :)
#appid and appkey already saved in .Renviron file
edamam_url <- "https://api.edamam.com/search"
edamam_data<- GET(edamam_url, query = list('q' = "chicken",
                                            app_id = Sys.getenv("appid"),
                                           app_key= Sys.getenv("appkey"),
                                            from = 0,
                                            to = 3,
                                            calories = "591-722",
                                            health = "alcohol-free"
  ))
edamam_data

#to show the content of edamam_data
#edamam_data$content
#To convert the raw Unicode into a character vector that resembles the JSON format
#rawToChar(edamam$content)

#To convert into list data use fromJSON() library

library(jsonlite)

#To show the content of the obtained data, change it from a raw data to actual characters
#and jsonformat and then turn it into a list from Json.

edamam_data_list <- edamam_data %>% 
                    .$content %>% 
                    rawToChar() %>% 
                    fromJSON()
edamam_data_list

```



### third level header


# Challenge 3
## Data Wrangling

#Challenge 4
## Data Visualization

Last compiled: `r Sys.Date()`

